FROM node:18-alpine

WORKDIR /app

# Ensure pnpm is available
RUN npm install -g pnpm

# Copy repository files
COPY . .

# Install dependencies including dev deps for the build step
RUN pnpm install --frozen-lockfile --prod=false

# Build the API so the compiled output exists in the image
RUN pnpm --filter @eventscrape/api build

# Expose the API port and run the compiled server
ENV NODE_ENV=production
EXPOSE 3001
CMD ["node", "apps/api/dist/server.js"]
